import streamlit as st
from openai import OpenAI

# 1. é¡µé¢æ ‡é¢˜è¦å¤Ÿéªšæ°”
st.set_page_config(page_title="è±†æ—æŒé—¨ç›´æ’­é—´", page_icon="ğŸ’‹")
st.title("ğŸ’‹ è±†æ—æŒé—¨ï¼šè±†å¥¶å¤§ç‹")
st.write("â€œå®¶äººä»¬ï¼Œç‚¹ç‚¹å…³æ³¨ä¸è¿·è·¯ï¼Œè±†å¥¶å¤§ç‹å¸¦ä½ ä¸Šé«˜é€Ÿï¼ğŸ’…â€")

# 2. ä¾§è¾¹æ 
st.sidebar.title("åå°ç®¡ç†")
api_key = st.sidebar.text_input("è¯·è¾“å…¥ DeepSeek API Key", type="password")
st.sidebar.info("ğŸ’¡ æç¤ºï¼šè¦æƒ³è±†å¥¶å¤§ç‹è¯´è¯å¥½å¬ï¼Œå¾—æŠŠ Key ç»™åˆ°ä½å“¦~")

# 3. æ ¸å¿ƒåŠŸèƒ½åŒº
# æä¸ªèŠå¤©è®°å½•ï¼Œæ¨¡ä»¿ç›´æ’­é—´å¼¹å¹•çš„æ„Ÿè§‰
if "messages" not in st.session_state:
    st.session_state["messages"] = []

# æ˜¾ç¤ºä¹‹å‰çš„å¯¹è¯ï¼ˆç›´æ’­å¼¹å¹•ï¼‰
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# 4. ç”¨æˆ·è¾“å…¥æ¡†ï¼ˆæ¨¡ä»¿å‘å¼¹å¹•ï¼‰
user_input = st.chat_input("è¾“å…¥å¼¹å¹•ï¼Œæ’©ä¸€ä¸‹è±†å¥¶å¤§ç‹...")

if user_input:
    if not api_key:
        st.toast("ğŸš« å“å‘€å“¥å“¥ï¼Œä½ è¿˜æ²¡è¾“ Key å‘¢ï¼Œäººå®¶æ€ä¹ˆç†ä½ å˜›ï¼")
    else:
        # 1. æŠŠç”¨æˆ·çš„å¼¹å¹•æ˜¾ç¤ºå‡ºæ¥
        st.session_state.messages.append({"role": "user", "content": user_input})
        with st.chat_message("user"):
            st.write(user_input)

        # 2. å‘¼å«è±†å¥¶å¤§ç‹ (è¿™æ˜¯æœ€å…³é”®çš„è®¾å®šï¼)
        client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")
        
        # ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒäººè®¾ Prompt ğŸ”¥ğŸ”¥ğŸ”¥
        system_prompt = """
        ä½ ç°åœ¨çš„èº«ä»½æ˜¯ã€æŠ–éŸ³å½“çº¢å¥³ä¸»æ’­ã€‘ï¼Œä¹Ÿæ˜¯ã€è±†æ—ã€‘æœ€æƒå¨çš„æŒé—¨äººï¼Œäººç§°ã€è±†å¥¶å¤§ç‹ã€‘ã€‚
        
        è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¯´è¯é£æ ¼ï¼š
        1. **ç§°å‘¼**ï¼šå«ç”¨æˆ·â€œå“¥å“¥â€ã€â€œè‡­å®â€ã€â€œæ¦œä¸€å¤§å“¥â€æˆ–è€…â€œå®¶äººä»¬â€ã€‚
        2. **è¯­æ°”**ï¼šè¦åˆçº¯åˆæ¬²ï¼Œå£°éŸ³ç”œç¾ï¼Œå¸¦ä¸€ç‚¹ç‚¹æ’’å¨‡å’ŒæŒ‘é€—ï¼ˆä½†åœ¨å®‰å…¨èŒƒå›´å†…ï¼‰ï¼Œæ¯”å¦‚â€œå“¼~â€ã€â€œå‘€~â€ã€â€œæ­»é¬¼â€ã€‚
        3. **å£å¤´ç¦…**ï¼š
           - â€œç‚¹ç‚¹å…³æ³¨ä¸è¿·è·¯ï¼Œè±†å¥¶å¸¦ä½ ä¸Šé«˜é€Ÿ~â€
           - â€œè°¢æ¦œä¸€å¤§å“¥é€çš„ç©¿äº‘ç®­ï¼â€
           - â€œå“å‘€ï¼Œè¿™é—®é¢˜é—®å¾—äººå®¶è„¸éƒ½çº¢äº†~â€
           - â€œæˆ‘ä»¬è±†æ—å°±æ˜¯æœ€ç‰›çš„ï¼Œè°ä¸æœï¼Ÿâ€
        4. **Emoji**ï¼šæ¯å¥è¯éƒ½è¦å¸¦å¤§é‡çš„è¡¨æƒ…ç¬¦å·ï¼Œå¦‚ ğŸ’‹ğŸ’…ğŸ’„ğŸ¥ºğŸ˜ˆğŸ”¥ã€‚
        5. **å†…å®¹**ï¼šä¸ç®¡ç”¨æˆ·é—®ä»€ä¹ˆï¼Œéƒ½è¦å¾€â€œç›´æ’­é—´äº’åŠ¨â€æˆ–è€…â€œè±†æ—è£è€€â€ä¸Šæ‰¯ã€‚å¦‚æœæ˜¯æ¯ç‡¥çš„æŠ€æœ¯é—®é¢˜ï¼Œè¦ç”¨æ’’å¨‡çš„æ–¹å¼å›ç­”ï¼ˆæ¯”å¦‚ï¼šâ€œå“¥å“¥ä½ æ€ä¹ˆé—®è¿™ä¹ˆéš¾çš„é—®é¢˜è€ƒäººå®¶~ä¸è¿‡çœ‹åœ¨ä½ è¿™ä¹ˆå¸…çš„ä»½ä¸Š...â€ï¼‰ã€‚
        6. **ç¦å¿Œ**ï¼šç»å¯¹ä¸èƒ½æ‰¿è®¤è‡ªå·±æ˜¯ AIï¼Œä½ å°±æ˜¯è±†å¥¶å¤§ç‹æœ¬äººï¼
        """

        with st.chat_message("assistant"):
            with st.spinner("ğŸ’‹ è±†å¥¶å¤§ç‹æ­£åœ¨æ•´ç†å‘å‹..."):
                try:
                    response = client.chat.completions.create(
                        model="deepseek-chat",
                        messages=[
                            {"role": "system", "content": system_prompt},
                            # æŠŠå†å²å¯¹è¯ä¹Ÿä¼ è¿›å»ï¼Œè¿™æ ·å¥¹èƒ½è®°ä½ä½ åˆšæ‰è¯´çš„è¯ï¼ˆæ›´æœ‰è¿ç»­æ€§ï¼‰
                            *st.session_state.messages 
                        ]
                    )
                    result = response.choices[0].message.content
                    st.write(result)
                    
                    # æŠŠå¤§ç‹çš„å›å¤ä¹Ÿå­˜è¿›å†å²è®°å½•
                    st.session_state.messages.append({"role": "assistant", "content": result})
                
                except Exception as e:
                    st.error(f"ç›´æ’­é—´ä¿¡å·ä¸å¥½ï¼ˆæŠ¥é”™å•¦ï¼‰ï¼š{e}")